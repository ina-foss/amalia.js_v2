<script src="./app/plugins/timeline/timeline-plugin.component.ts"></script>
<div class="toolbar-container">
    <p-toolbar>
        <div class="p-toolbar-group-end">
            <div class="flex items-center gap-2 toolbar-end-buttons">
                <p-button icon="pi pi-search-minus" [rounded]="true" (onClick)="unZoom()"></p-button>
                <p-button id="timeline-toolbar-filter-button" icon="pi pi-filter" [rounded]="true"
                    (onClick)="toggleConfig()"></p-button>
            </div>
        </div>
    </p-toolbar>
</div>

<div class="main-block" #mainBlockContainer>
    <div class="pad">
        <div class="tc-cursor"></div>
    </div>
    <div class="timeline-block">
        <div class="focus handle-border" #focusContainer>
            <div class="time-code">
                <span *ngIf="focusTcOut" class="start">{{ focusTcIn|tcFormat:timeFormat:fps }}</span>
                <span *ngIf="focusTcIn" class="middle">-</span>
                <span *ngIf="focusTcOut" class="end">{{ focusTcOut|tcFormat:timeFormat:fps }}</span>
            </div>
        </div>
        <div class="pad">
            <div class="timeline" #mainTimeline>
                <ng-container *ngFor="let loc of mainLocalisations" [ngSwitch]="loc.tcIn!=null && loc.tcOut!=null">
                    <div class="cue-point" *ngSwitchDefault [attr.data-color]="loc.color"
                        [ngStyle]="{ left:((loc.tc*100)/duration)+'%' ,'background-color': loc.color ?loc.color:mainBlockColor}"
                        [attr.data-tc]="loc.tc" (click)="callSeek(loc.tc)"></div>
                    <div class="segment" *ngSwitchCase="true" [attr.data-tc]="loc.tcIn" (click)="callSeek(loc.tcIn)"
                        [attr.data-color]="loc.color"
                        [ngStyle]="{left:((loc.tcIn*100)/duration)+'%', width:((loc.tcOut-loc.tcIn)*100)/duration+'%','background-color': loc.color ?loc.color:mainBlockColor }">
                    </div>
                </ng-container>
            </div>
        </div>

    </div>
</div>
<div class="list-blocks" #listOfBlocksContainer [sortablejs]="listOfBlocks" [sortablejsOptions]="sortableOptions"
    appPreventCtrlScroll>
    <div class="pad">
        <div class="tc-cursor"></div>
    </div>
    <div class="tooltip" #selectedBlockElement>
        <p *ngIf="selectedBlock?.thumb">{{ selectedBlock.thumb }}</p>
        <p *ngIf="selectedBlock?.label" class="label">{{ selectedBlock.label }}</p>
        <p *ngIf="selectedBlock?.tc" class="tc">Tc:{{ selectedBlock.tc }}</p>
        <p *ngIf="selectedBlock?.tcIn&&selectedBlock?.tcOut" class="tc">
            <span class="start">{{ selectedBlock.tcIn|tcFormat:timeFormat:fps }}</span>
            <span class="middle">-</span>
            <span class="end">{{ selectedBlock.tcOut|tcFormat:timeFormat:fps }}</span>
        </p>
    </div>
    <p-accordion #listOfBlocksAccordion [multiple]="true" [activeIndex]="listOfBlocksIndexes"
        (activeIndexChange)="refreshTimeCursor()" (onClose)="refreshTimeCursor()" (onOpen)="refreshTimeCursor()">
        <ng-container *ngFor="let block of listOfBlocks; let idx = index">
            <p-accordionTab [ngClass]="{'hidden-timeline':block.displayState===false}" iconPos="start" class="grabbable"
                pDraggable="listOfBlocks" pDroppable="listOfBlocks" (onDragStart)="onDragStart(idx)"
                (onDrop)="onDrop(idx)">
                <ng-template pTemplate="header">
                    <div class="block-header" *ngIf="block.label!=''">
                        <div class="timeline-block-label">
                            <i [class]="block.icon"></i>{{ block.label }}
                        </div>
                        <div class="block-header-buttons">
                            <p-button icon="pi pi-times" (click)="removeBlock(block)" (keyPress)="removeBlock(block)"
                                (keyDown)="removeBlock(block)" (keyUp)="removeBlock(block)" [text]="true"></p-button>
                        </div>
                    </div>
                </ng-template>
                <ng-template pTemplate="content">
                    <div class="timeline">
                        <ng-container *ngFor="let loc of block.data" [ngSwitch]="loc.tcIn!=null && loc.tcOut!=null">
                            <div class="cue-point" *ngSwitchDefault (mouseenter)="handleMouseEnterOnTc($event,loc)"
                                (mouseleave)="handleMouseLeaveOnTc($event)"
                                (keyPress)="handleMouseEnterOnTc($event,loc)"
                                (keyDown)="handleMouseEnterOnTc($event,loc)" (keyUp)="handleMouseEnterOnTc($event,loc)"
                                [ngStyle]="{'background-color': block.data.color ?block.data.color:block.defaultColor, left:(((loc.tc-focusTcIn)*100)/(focusTcOut-focusTcIn))+'%' }"
                                [attr.data-tc]="loc.tc" [attr.data-type]="loc.type" (click)="callSeek(loc.tc)"></div>
                            <div class="segment" *ngSwitchCase="true" [attr.data-tc]="loc.tcIn"
                                [attr.data-type]="loc.type" (click)="callSeek(loc.tcIn)"
                                (keyPress)="handleMouseEnterOnTc($event,loc)"
                                (keyDown)="handleMouseEnterOnTc($event,loc)" (keyUp)="handleMouseEnterOnTc($event,loc)"
                                (mouseenter)="handleMouseEnterOnTc($event,loc)"
                                (mouseleave)="handleMouseLeaveOnTc($event)"
                                [ngStyle]="{'background-color': block.data.color ?block.data.color:block.defaultColor,left:(((loc.tcIn-focusTcIn)*100)/(focusTcOut-focusTcIn))+'%', width:((loc.tcOut-loc.tcIn)*100)/(focusTcOut-focusTcIn)+'%' }">
                            </div>
                        </ng-container>
                    </div>
                </ng-template>
            </p-accordionTab>
        </ng-container>
    </p-accordion>
</div>
<div class="segment-empty"></div>
<div class="menu" #menuContainer [ngClass]="{'open':configIsOpen}">
    <div class="content" id="menu-content">
        <div class="header">
            <div class="select-segments">
                <div class="p-checkbox p-component" aria-hidden="true" inputId="select-segments" id="select-segments">
                    <div class="p-checkbox-box"
                        [ngClass]="{ 'p-highlight': allNodesChecked || indeterminate, 'p-indeterminate': indeterminate, 'p-checkbox-focused': isSelectSegmentsFocused }"
                        (click)="toggleAllNodes()" (keyPress)="toggleAllNodes()" (keyDown)="toggleAllNodes()"
                        (keyUp)="toggleAllNodes()" (focus)="isSelectSegmentsFocused=true"
                        (blur)="isSelectSegmentsFocused=false">
                        <CheckIcon *ngIf="!indeterminate && allNodesChecked" [styleClass]="'p-checkbox-icon'" />
                        <MinusIcon *ngIf="indeterminate" [styleClass]="'p-checkbox-icon'" />
                    </div>
                </div>
                <label for="select-segments"
                    [ngClass]="{ 'p-checkbox-label-active': allNodesChecked || indeterminate, 'p-checkbox-label-focus': isSelectSegmentsFocused }"
                    class="p-checkbox-label ng-star-inserted p-checkbox-label-active" (click)="toggleAllNodes()"
                    (keyPress)="toggleAllNodes()" (keyDown)="toggleAllNodes()" (keyUp)="toggleAllNodes()"> SÃ©lectionner
                    des
                    segments</label>
            </div>


            <p-button *ngIf="filterHidden" icon="pi pi-search" [rounded]="true" (click)="toggleFilter()"
                (keyPress)="toggleFilter()" (keyDown)="toggleFilter()" (keyUp)="toggleFilter()"
                class="btn-show-filter" />
            <p-button *ngIf="!filterHidden" icon="pi pi-times" [rounded]="true" [text]="true" severity="secondary"
                (click)="toggleFilter()" (keyPress)="toggleFilter()" (keyDown)="toggleFilter()" (keyUp)="toggleFilter()"
                class="btn-hide-filter" />
        </div>
        <div class="main">
            <p-tree *ngIf="filterHidden" [value]="nodes" selectionMode="checkbox" [(selection)]="selectedNodes"
                (selectionChange)="updateTreeComponent()">
                <ng-template let-node pTemplate="default">
                    <span *ngIf="node.data && node.data.color" class="color"
                        [ngStyle]="{'background-color':node.data.color}"></span>
                    {{ node.label }}
                </ng-template>
            </p-tree>
            <p-tree *ngIf="!filterHidden" [value]="nodes" selectionMode="checkbox" [filter]="true"
                filterPlaceholder="Rechercher..." filterMode="strict" [(selection)]="selectedNodes"
                (selectionChange)="updateTreeComponent()" (onFilter)="filterNodes($event)">
                <ng-template let-node pTemplate="default">
                    <span *ngIf="node.data && node.data.color" class="color"
                        [ngStyle]="{'background-color':node.data.color}"></span>
                    {{ node.label }}
                </ng-template>
            </p-tree>
        </div>
        <div class="footer">
            <p-button class="no-highlight" (click)="handleDisplayBlocks(false)"
                (keyPress)="handleDisplayBlocks(false)">Annuler</p-button>
            <p-button class="highlight" (click)="handleDisplayBlocks(true)"
                (keyPress)="handleDisplayBlocks(true)">Valider</p-button>
        </div>
    </div>
</div>