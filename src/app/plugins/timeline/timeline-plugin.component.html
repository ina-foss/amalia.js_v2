<script src="./app/plugins/timeline/timeline-plugin.component.ts"></script>
<div class="toolbar-container"><ng-container *ngIf="showTollbar;then toolbar else hiddenToolbar"></ng-container>
    <ng-template #toolbar>
        <p-toolbar>
            <div class="p-toolbar-group-start">
                <div class="synchro-switch">
                    <span class="synchro-switch-label">Synchroniser</span><p-inputSwitch [(ngModel)]="checkedSyncro" />
                </div>
            </div>
            <div class="p-toolbar-group-end">
                <div class="flex items-center gap-2 toolbar-end-buttons">
                    <p-button icon="pi pi-search-minus" [rounded]="true" (onClick)="toggleConfig()"></p-button>
                    <p-button icon="pi pi-filter" [rounded]="true" (onClick)="toggleConfig()"></p-button>
                </div>
            </div>
        </p-toolbar>
        <div class="full-width"><p-button icon="pi pi-chevron-up" [rounded]="true" [text]="true"
                class="toolbar-toggle-button" (onClick)="hideToolbar()"></p-button></div>
    </ng-template>
    <ng-template #hiddenToolbar>
        <div class="full-width"><p-button icon="pi pi-chevron-down" [rounded]="true" [text]="true"
                class="toolbar-toggle-button" (onClick)="showToolbar()"></p-button></div>
    </ng-template>
</div>

<div class="main-block" #mainBlockContainer>
    <div class="tc-cursor"></div>
    <div class="timeline-block main">
        <div class="focus" #focusContainer>
            <div class="time-code" *ngIf="focusTcOut">
                <span class="start">{{ focusTcIn|tcFormat:timeFormat:fps }}</span>
                <span> - </span>
                <span class="end ">{{ focusTcOut|tcFormat:timeFormat:fps }}</span>
            </div>
        </div>
        <div class="timeline">
            <ng-container *ngFor="let loc of mainLocalisations" [ngSwitch]="loc.tcIn!=null && loc.tcOut!=null">
                <div class="cue-point" *ngSwitchDefault [attr.data-color]="loc.color"
                    [ngStyle]="{ left:((loc.tc*100)/duration)+'%' ,'background-color': loc.color ?loc.color:mainBlockColor}"
                    [attr.data-tc]="loc.tc" (click)="callSeek(loc.tc)"></div>
                <div class="segment" *ngSwitchCase="true" [attr.data-tc]="loc.tcIn" (click)="callSeek(loc.tcIn)"
                    [attr.data-color]="loc.color"
                    [ngStyle]="{left:((loc.tcIn*100)/duration)+'%', width:((loc.tcOut-loc.tcIn)*100)/duration+'%','background-color': loc.color ?loc.color:mainBlockColor }">
                </div>
            </ng-container>
        </div>
    </div>
</div>
<div class="list-blocks" #listOfBlocksContainer [sortablejs]="listOfBlocks" [sortablejsOptions]="sortableOptions">
    <div class="tc-cursor"></div>
    <div class="rectangle" #selectionContainer></div>
    <div class="tooltip" #selectedBlockElement>
        <p *ngIf="selectedBlock?.thumb">{{ selectedBlock.thumb }}</p>
        <p *ngIf="selectedBlock?.label" class="label">{{ selectedBlock.label }}</p>
        <p *ngIf="selectedBlock?.tc" class="tc">Tc:{{ selectedBlock.tc }}</p>
        <p *ngIf="selectedBlock?.tcIn&&selectedBlock?.tcOut" class="tc">
            <span class="start">Tc: {{ selectedBlock.tcIn|tcFormat:timeFormat:fps }}</span>
            <span> - </span>
            <span class="end ">{{ selectedBlock.tcOut|tcFormat:timeFormat:fps }}</span>
        </p>
    </div>
    <div class="timeline-block" #mainBlock *ngFor="let block of listOfBlocks;"
        [ngClass]=" {'hidden-timeline':block.displayState===false}">
        <div class="block-header" *ngIf="block.label!=''">
            <div class="extend">
                <svg class="amalia-svg-down-size icon" *ngIf="block.expendable" (click)="toggleState(mainBlock)">
                    <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#down'"></use>
                </svg>
                {{ block.label }}
            </div>
            <div class="drag" [hidden]="!enableDragDrop">
                <svg class="amalia-svg-drag-drop-size icon">
                    <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#drag-drop'"></use>
                </svg>
            </div>
        </div>
        <div class="timeline">
            <ng-container *ngFor="let loc of block.data" [ngSwitch]="loc.tcIn!=null && loc.tcOut!=null">
                <div class="cue-point" *ngSwitchDefault (mouseenter)="handleMouseEnterOnTc($event,loc)"
                    (mouseleave)="handleMouseLeaveOnTc($event)"
                    [ngStyle]="{'background-color': block.defaultColor ?block.defaultColor:block.defaultColor, left:(((loc.tc-focusTcIn)*100)/(focusTcOut-focusTcIn))+'%' }"
                    [attr.data-tc]="loc.tc" [attr.data-type]="loc.type" (click)="callSeek(loc.tc)"></div>
                <div class="segment" *ngSwitchCase="true" [attr.data-tc]="loc.tcIn" [attr.data-type]="loc.type"
                    (click)="callSeek(loc.tcIn)" (mouseenter)="handleMouseEnterOnTc($event,loc)"
                    (mouseleave)="handleMouseLeaveOnTc($event)"
                    [ngStyle]="{'background-color': block.defaultColor ?block.defaultColor:block.defaultColor,left:(((loc.tcIn-focusTcIn)*100)/(focusTcOut-focusTcIn))+'%', width:((loc.tcOut-loc.tcIn)*100)/(focusTcOut-focusTcIn)+'%' }">
                </div>
            </ng-container>
        </div>
    </div>
</div>
<div class="footer">
    <div class="state-control" #stateControl (click)="toggleAllBlocksState(listOfBlocksContainer, stateControl)">
        <svg class="amalia-svg-down-size icon">
            <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#down'"></use>
        </svg>
        Fermer toutes les timelines
    </div>
    <div class="unzoom" (click)="unZoom()">
        <svg class="amalia-svg-unzoom-size icon">
            <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#unzoom'"></use>
        </svg>
    </div>
    <div class="actions">
        <div>Actions :</div>
        <div class="zoom" [ngClass]="{'selected':enableZoom}" (click)="handleEnableZoom()">
            <svg class="amalia-svg-zoom-size icon">
                <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#zoom'"></use>
            </svg>
            Zoom
        </div>
        <div class="drag-drop" [ngClass]="{'selected':enableDragDrop}" (click)="enableDragDrop=!enableDragDrop">
            <svg class="amalia-svg-hand-size icon">
                <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#hand'"></use>
            </svg>
            Déplacer
        </div>
    </div>
</div>
<div class="segment-empty"></div>
<div class="menu" [ngClass]="{'open':configIsOpen}">
    <div class="content">
        <div class="header">
            <p-checkbox label="Sélectionner des segments" [(ngModel)]="allNodesChecked" [binary]="true"
                inputId="select-segments" (onChange)="toggleAllNodes()" />
            <p-button *ngIf="filterHidden" icon="pi pi-search" [rounded]="true" (click)="toggleFilter()"
                class="btn-show-filter" />
            <p-button *ngIf="!filterHidden" icon="pi pi-times" [rounded]="true" [text]="true" severity="secondary"
                (click)="toggleFilter()" class="btn-hide-filter" />
        </div>
        <div class="main">
            <p-tree *ngIf="filterHidden" [value]="nodes" selectionMode="checkbox" [(selection)]="selectedNodes">
                <ng-template let-node pTemplate="default">
                    <span *ngIf="node.data && node.data.color" class="color"
                        [ngStyle]="{'background-color':node.data.color}"></span>
                    {{ node.label }}
                </ng-template>
            </p-tree>
            <p-tree *ngIf="!filterHidden" [value]="nodes" selectionMode="checkbox" [filter]="true"
                filterPlaceholder="Rechercher..." filterMode="strict" [(selection)]="selectedNodes"
                (onFilter)="filterNodes($event)">
                <ng-template let-node pTemplate="default">
                    <span *ngIf="node.data && node.data.color" class="color"
                        [ngStyle]="{'background-color':node.data.color}"></span>
                    {{ node.label }}
                </ng-template>
            </p-tree>
        </div>
        <div class="footer">
            <p-button class="no-highlight" (click)="handleDisplayBlocks(false)">Annuler</p-button>
            <p-button class="highlight" (click)="handleDisplayBlocks(true)">Valider</p-button>
        </div>
    </div>
    <div class="segment-empty"></div>
</div>