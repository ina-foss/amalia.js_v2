<form #segmentForm="ngForm">
    <amalia-toast #toast position="bottom-center" key="segment" />
    <div class="readonly-segment">
        <p-card [class]="{'segment-selected':segment.data.selected}">
            <ng-template pTemplate="header">
                <div *ngIf="segment.data.isTitleEditing === false" #titlediv class="segment-title ellipsis"
                    [tooltip]="isEllipsed?segment.label:''" (click)="startTitleEdit()">
                    {{ (segment.label === '' || segment.label === undefined) ? SEGMENT_SANS_TITRE :
                    segment.label }}
                </div>
                <div *ngIf="segment.data.isTitleEditing === true" class="readonly-title-container">
                    <div class="readonly-title-edit">
                        <textarea #titleInputReadonly id="title" name="title" [(ngModel)]="segment.label" rows="1"
                            cols="30" pInputTextarea [autoResize]="true" (focus)="muteShortCuts()"
                            (blur)="onTitleBlur()" (keydown)="onTitleEditKeydown($event)"
                            placeholder="Ajouter un titre"></textarea>
                        <div class="title-edit-actions">
                            <p-button icon="pi pi-check" [text]="true" severity="success" (click)="confirmTitleEdit()"
                                [disabled]="segment.label && segment.label.length > 250" tooltip="Valider" />
                            <p-button icon="pi pi-times" [rounded]="true" [outlined]="true" size="small"
                                severity="danger" (click)="cancelTitleEdit()" tooltip="Annuler" />
                        </div>
                    </div>
                    <small class="segment-title-alignment"
                        *ngIf="(segment.data.isTitleEditing=== true) && segment.label && segment.label.length > 250"
                        id="title-error">
                        250 caractères maximum.
                    </small>
                </div>
                <div class="header-buttons">
                    <p-button id="btnclone" icon="pi pi-clone" (click)="cloneSegment()" [text]="true"
                        severity="secondary" tooltip="Dupliquer un segment" />
                    <p-button id="btnremove" icon="pi pi-trash" (click)="removeSegment()" [text]="true"
                        severity="danger" tooltip="Supprimer" />
                    <p-button *ngIf="segment.data.idDocument" id="btnclone" icon="pi pi-fw pi-file"
                        (click)="openNotilusMaterial()" [text]="true" severity="secondary"
                        tooltip="Ouvrir dans Notilus" />
                </div>
            </ng-template>
            <p-divider />
            <div>
                <div class="readonly-segment-info">
                    <div class="readonly-segment-thumbnail-block">
                        <div
                            [ngClass]="{'readonly-segment-thumbnail': !segment.thumb, 'readonly-segment-thumbnail-no-background':segment.thumb}">
                            <div *ngIf="segment.data.media ==='audio' || segment.data.media ==='AUDIO' || segment.thumb === 'assets/amalia/images/newAudioBackGround.png'"
                                class="thumbnail readonly-segment-audioThumbnail"></div>
                            <svg class="amalia-svg-blue-play-size icon" (click)="playMedia()">
                                <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#blue-play'"></use>
                            </svg>
                            <img *ngIf="segment.data.media !=='audio' && segment.data.media !=='AUDIO' && segment.thumb !== 'assets/amalia/images/newAudioBackGround.png'"
                                class="thumbnail" alt='thumbnail' [src]="segment.thumb" />
                        </div>
                        <p-button icon="pi pi-camera" (click)="updateThumbnail()" tooltip="Sélectionner une imagette"
                            rounded="true" outlined="true" size="small" severity="secondary"
                            [ngClass]="{'readonly-segment-no-camera-icon' : segment.data.media ==='audio' || segment.data.media ==='AUDIO' || segment.thumb === 'assets/amalia/images/newAudioBackGround.png'}" />
                    </div>
                    <div class="readonly-segment-info-content">
                        <div class="readonly-segment-tc">
                            <div class="readonly-segment-tc-item">
                                <span *ngIf="segment.data.isTcInEditing === false" (click)="startTcInEdit()">
                                    Début : {{ segment.tcIn | tcFormat:tcDisplayFormat }}
                                </span>
                                <div *ngIf="segment.data.isTcInEditing === true" class="readonly-tc-edit">
                                    <span>Début :</span>
                                    <input #tcInReadonlyInput pInputText id="tcInReadonly" name="tcIn" [(ngModel)]="tcInFormatted"
                                        class="tc-input-inline" (focus)="muteShortCuts()" (blur)="onTcInBlur()"
                                        (keydown)="onTcInKeydown($event)" />
                                </div>
                            </div>
                            <div class="readonly-segment-tc-item">
                                <span *ngIf="segment.data.isTcOutEditing === false" (click)="startTcOutEdit()">
                                    Fin : {{ segment.tcOut | tcFormat:tcDisplayFormat }}
                                </span>
                                <div *ngIf="segment.data.isTcOutEditing === true" class="readonly-tc-edit">
                                    <span>Fin :</span>
                                    <input #tcOutReadonlyInput pInputText id="tcOutReadonly" name="tcOut" [(ngModel)]="tcOutFormatted"
                                        class="tc-input-inline" (focus)="muteShortCuts()" (blur)="onTcOutBlur()"
                                        (keydown)="onTcOutKeydown($event)" />
                                </div>
                            </div>
                            <div class="readonly-segment-tc-item">
                                <span *ngIf="segment.data.isTcEditing === false" (click)="startTcEdit()">
                                    Durée : {{ segment.tc |tcFormat:tcDisplayFormat }}
                                </span>
                                <div *ngIf="segment.data.isTcEditing === true" class="readonly-tc-edit">
                                    <span>Durée :</span>
                                    <input #tcReadonlyInput pInputText id="tcReadonly" name="tc" [(ngModel)]="tcFormatted"
                                        class="tc-input-inline" (focus)="muteShortCuts()" (blur)="onTcBlur()"
                                        (keydown)="onTcKeydown($event)"/>
                                </div>
                            </div>
                        </div>
                        <p-divider />
                        <div class="readonly-segment-categories" #readOnlyCategoriesDiv>
                            <ng-container *ngIf="segment.data.isCategoriesEditing === false">
                                <div (click)="startCategoriesEdit()" class="readonly-segment-categories-readonly">
                                    <ng-container *ngIf="categories().length > 0">
                                        <p-chip *ngFor="let category of categories()" [label]="category"
                                            [tooltip]="textLatoWidthHigherThan(category,300)?category:''" />
                                        <p-chip id="hiddenCategoriesSummaryChip" [label]=" '+' + hiddenCategoriesCount"
                                            [tooltip]="displayRemaining(categories(),hiddenCategoriesCount)" />
                                    </ng-container>
                                    <ng-container *ngIf="categories().length === 0">
                                        <span class="readonly-segment-no-categories">Catégories: aucune</span>
                                    </ng-container>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="segment.data.isCategoriesEditing === true">
                                <div #categoriesReadonlyWrapper>
                                    <p-autoComplete id="categoriesReadonly" name="categories" [(ngModel)]="categories"
                                        [suggestions]="filteredCategories" (completeMethod)="searchCategories($event)"
                                        [multiple]="true" inputId="categories" [forceSelection]="true"
                                        (ngModelChange)="addToAvailableCategories($event)" (onFocus)="muteShortCuts()"
                                        (onBlur)="onCategoriesBlur()"></p-autoComplete>
                                </div>
                            </ng-container>
                        </div>
                        <div class="readonly-segment-keywords" #readOnlyKeywordsDiv>
                            <ng-container *ngIf="segment.data.isKeywordsEditing === false">
                                <div (click)="startKeywordsEdit()" class="readonly-segment-keywords-readonly">
                                    <ng-container *ngIf="keywords().length > 0">
                                        <p-chip *ngFor="let keyword of keywords()" [label]="keyword"
                                            [tooltip]="textLatoWidthHigherThan(keyword,300)?keyword:''" />
                                        <p-chip id="hiddenKeywordsSummaryChip" [label]=" '+' + hiddenKeywordsCount"
                                            [tooltip]="displayRemaining(keywords(),hiddenKeywordsCount)" />
                                    </ng-container>
                                    <ng-container *ngIf="keywords().length === 0">
                                        <span class="readonly-segment-no-keywords">Mots-clés: aucun</span>
                                    </ng-container>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="segment.data.isKeywordsEditing === true">
                                <div #keywordsReadonlyWrapper>
                                    <p-autoComplete id="keywordsReadonly" name="keywords" [(ngModel)]="keywords"
                                        [suggestions]="filteredKeywords" (completeMethod)="searchKeywords($event)"
                                        [multiple]="true" inputId="keywords" [forceSelection]="true"
                                        (ngModelChange)="addToAvailableKeywords($event)" (onFocus)="muteShortCuts()"
                                        (onBlur)="onKeywordsBlur()"></p-autoComplete>
                                </div>
                            </ng-container>
                        </div>
                        <ng-container
                            *ngIf="(!segment.description || segment.description.length === 0 || segment.description.trim().length === 0) && !segment.data.isDescriptionEditing">
                            <div class="readonly-segment-description-empty" (click)="startDescriptionEdit()"
                                style="cursor: pointer;">
                                Description: aucune
                            </div>
                        </ng-container>
                    </div>
                </div>
                <div *ngIf="(segment.data.isDescriptionEditing===false) && segment.description && segment.description.length !== 0 && segment.description.trim().length !== 0"
                    class="readonly-segment-description">
                    <p #descp [class.collapsed]="isDescriptionCollapsed" (click)="startDescriptionEdit()"
                        style="cursor: pointer;">
                        {{ segment.description }}
                    </p>
                    <div *ngIf="isDescriptionTruncated" class="readonly-segment-description-icon"
                        [ngClass]="{'withShadowUp' : isDescriptionCollapsed, 'withShadowDown':!isDescriptionCollapsed}"
                        (click)="toggleDescription($event)">
                        <svg *ngIf="isDescriptionCollapsed" class="amalia-svg-down-size icon">
                            <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#down2'"></use>
                        </svg>
                        <svg *ngIf="!isDescriptionCollapsed" class="amalia-svg-up-size icon">
                            <use [attr.xlink:href]="'assets/svgs/symbol/svg/sprite.symbol.svg#up2'"></use>
                        </svg>
                    </div>
                </div>
                <div *ngIf="segment.data.isDescriptionEditing===true" class="readonly-description-edit-container">
                    <div class="readonly-description-edit">
                        <textarea #descriptionReadonlyTextarea id="descriptionReadonly" name="description" [(ngModel)]="segment.description" rows="5"
                            cols="30" pInputTextarea [autoResize]="true" (focus)="muteShortCuts()"
                            (blur)="onDescriptionBlur()" (keydown)="onDescriptionKeydown($event)"
                            placeholder="Ajouter une description"></textarea>
                        <div class="description-edit-actions">
                            <p-button icon="pi pi-check" [text]="true" severity="success"
                                (click)="confirmDescriptionEdit()"
                                [disabled]="segment.description && segment.description.length > 1000"
                                tooltip="Valider" />
                            <p-button icon="pi pi-times" [rounded]="true" [outlined]="true" size="small"
                                severity="danger" (click)="cancelDescriptionEdit()" tooltip="Annuler" />
                        </div>
                    </div>
                    <small class="segment-description-alignment"
                        *ngIf="segment.description && segment.description.length > 1000" id="description-error">
                        1000 caractères maximum.
                    </small>
                </div>
            </div>
        </p-card>
    </div>
</form>